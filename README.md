Система умного дома, главной особенностью является модульное устройство узлов системы. Основой системы является MQTT протокол (или подобный ему, поддерживающий топики и подписки на них). Система является многоуровневой сетью, на вершине которой находится MQTT сервер, к нему подключаются узлы первого уровня. К этим узлам подключаются датчики и узлы более низкого уровня. Каждый узел уровня ниже первого общается с узлом более высокого уровня при помощи класса Interface, а с узлами более низкого уровня при помощи класса SensorInterface, при этом узел i-го уровня видит подключенные к нему узлы i + 1 уровня как датчики, соответсвтенно каждый уровень абстрагирован от того, как общаются между собой узлы более высокого уровня, а также все узлы более низкого уровня. Для подключения датчиков необходимы интерфейсы.
На данный момент реализованы эти интерфейсы для связи ardiuino nano и esp32 по nrf24 и связи между esp32 и MQTT сервером, интерфейсы для следующих датчиков: oled экран, LED-светодиод с регулируемой яркостью, DHT11, семисегментный индикатор, сервопривод.
В случае использования датчиков, для которых уже написаны интерфейсы, пользователю необходимо лишь указать, какой интерфейс должен использовать его датчик.
В случае использования датчиков, протоколов связи или микроконтроллеров, реализации для которых нет, пользователю необходимо написать два класса: для дочернего узла класс, унаследованный от класса Sensor, описанного в заголовочном файле Sensors_interface.h, для родительского узла класс, унаследованный от Interface.h
Рассматрим на примере реализованных датчиков.
В первом узле - esp32 есть класс MQTTInterface, который является оболочкой для библиотеки PubSubClient, который реализует множественное подключение по одномк каналу MQTT. Экземпляры этого класса создаются каждым классом-сенсором и они общаются с сервером через прослойку этого класса. Интерфейс при поступлении сообщения от сеовера в котором говориться что изменился топик вызывает функции обработки изменений каждого класса-сенсора, которые подписаны на этот топик. Такая реализация позволяет другим интерфейсам представляться как датчик и таким образом реализовывать сеть сенсоров, связанных несколькими типами связи. В примере таким импостером является RF24_Sensor, который реализует радио связь через nrf24l01. Радио связывает esp32 и ArduinoNano код для который так же есть в репозитории.


Видео работы: https://drive.google.com/file/d/1gzn5Dfw6xVPNSvU6FJxVRI67QRTQuPg1/view?usp=sharing
